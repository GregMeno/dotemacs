((tags "egg") (section 2 "Spiffy" (toc) (section 3 "Description" (p "A small web-server written in " (link "http://www.call-with-current-continuation.org" "Chicken") ".")) (section 3 "Author" (p (int-link "/users/felix-winkelmann" "Felix Winkelmann") ". Currently maintained by " (int-link "/users/peter-bex" "Peter Bex") ".")) (section 3 "Requirements" (p "Requires the " (int-link "intarweb") ", " (int-link "uri-common") ", " (int-link "defstruct") ", " (int-link "matchable") " and " (int-link "sendfile") " extensions.")) (section 3 "Documentation" (p "Spiffy is a web-server library for the Chicken Scheme system. It's quite easy to set up and use (whether as a library or a standalone server application) and it can be customized in numerous ways.")) (section 3 "Starting the server" (p "To start the server with minimal configuration hassle, there's a simple procedure to help you do that:") (def (sig (procedure "(start-server [port: port-number] [bind-address: address] [listen: listen-procedure] [accept: accept-procedure])" (id start-server))) (p "Starts the server, to listen on the given port. Other configuration can be tweaked through SRFI-39 parameters. These are listed below. Once the server is started, server behaviour can be controlled through these parameters as well.  After the listener is started, when " (tt "spiffy-user") " and/or " (tt "spiffy-group") " are provided, this procedure will drop privileges before starting the accept loop.") (p "By default, Spiffy will only serve static files. On directories, it will give a \"403 forbidden\", unless there is an index-file. If there is, that file's contents will be shown.") (p "All arguments directly supplied to " (tt "start-server") " override the configuration parameter values and will be parameterized to reflect this new setting.") (p (tt "port-number") " defaults to the value of " (tt "server-port") " (see below). " (tt "bind-address") " defaults to the value of " (tt "server-bind-address") " (see below). " (tt "listen") " defaults to " (tt "tcp-listen") " and should accept a port number, backlog and bind address. " (tt "accept") " defaults to " (tt "tcp-accept") ", and is passed on as-is to " (tt "accept-loop") ".")) (def (sig (procedure "(accept-loop listener accept)" (id accept-loop))) (p "This procedure starts the loop which accepts incoming connections and fires off threads to handle requests on those connections.  You can use it if you need more control over the startup process than " (tt "start-server") " offers.  For example, you can set up an SSL context and drop privileges, and possibly load extra code before starting the accept loop (Spiffy contains the required code to detect SSL ports, and will handle those more-or-less transparently):") (highlight scheme "(use spiffy openssl)\n\n(server-port 443)\n(spiffy-user \"www\")\n(spiffy-group \"www\")\n\n;; Bind the port as root, before we drop privileges\n(define listener (ssl-listen (server-port)))\n\n;; Load the certificate files as root so we can secure their permissions\n(ssl-load-certificate-chain! listener \"server.pem\")\n(ssl-load-private-key! listener \"server.key\")\n\n;; Drop root privileges\n(switch-user/group (spiffy-user) (spiffy-group))\n  \n;; We don't want to load this extra code as root!\n(load \"extra-code.scm\")\n\n;; Done! Start listening for connections.\n(accept-loop listener ssl-accept)")) (def (sig (procedure "(switch-user/group user group)" (id switch-user/group))) (p "This is a helper procedure which allows you to easily drop privileges before running the accept loop.  The user and group must be either strings or UID/GID numbers which indicate the username and groupname to which you want to switch.  Either is also allowed to be " (tt "#f") ", if you don't want to switch that aspect of the process."))) (section 3 "Configuration parameters" (p "The following parameters can be used to control spiffy's behaviour. Besides these parameters, you can also influence spiffy's behaviour by tweaking the " (int-link "intarweb") " parameters.") (def (sig (parameter "(server-software [product])" (id server-software))) (p "The server software product description. This should be a valid product value as used in the server and user-agent headers by intarweb; this is a list of lists. The inner lists contain the product name, the product version and a comment, all either a string or " (tt "#f") ". Default: " (tt "((\"Spiffy\" \"a.b\" \"Running on Chicken x.y\"))") ", with " (tt "a.b") " being the Spiffy major/minor version and " (tt "x.y") " being Chicken's.")) (def (sig (parameter "(root-path [path])" (id root-path))) (p "The path to the document root, for the current vhost. Defaults to " (tt "\"./web\"") ".")) (def (sig (parameter "(server-port [port-number])" (id server-port))) (p "The port number on which to listen. Defaults to 8080.")) (def (sig (parameter "(server-bind-address [address])" (id server-bind-address))) (p "The IP address on which to listen, or all addresses if " (tt "#f") ". Defaults to " (tt "#f") ".")) (def (sig (parameter "(max-connections [number])" (id max-connections))) (p "The maximum number of simultaneously active connections. Defaults to 1024.") (p "Any new connection that comes in when this number is reached must wait until one of the active connections is closed.")) (def (sig (parameter "(spiffy-user [name-or-uid])" (id spiffy-user))) (p "The name or UID of a user to switch to just after binding the port. This only works if you start Spiffy as root, so it can bind port 80 and then drop privileges. If " (tt "#f") ", no switch will occur. Defaults to " (tt "#f") ".")) (def (sig (parameter "(spiffy-group [name-or-gid])" (id spiffy-group))) (p "The name or GID of a group to switch to just after binding the port. This only works if you start Spiffy as root, so it can bind port 80 and then drop privileges. If " (tt "#f") ", it will be set to the primary group of " (tt "spiffy-user") " if the user was selected. Otherwise, no change will occur.  Defaults to " (tt "#f") ".")) (def (sig (parameter "(index-files [file-list])" (id index-files))) (p "A list of filenames which are to be used as index files to serve when the requested URL identifies a directory.  Defaults to " (tt "'(\"index.html\" \"index.xhtml\")"))) (def (sig (parameter "(mime-type-map [extension->mimetype-list])" (id mime-type-map))) (p "An alist of extensions (strings) to mime-types (symbols), to use for the content-type header when serving up a static file. Defaults to") (pre " '((\"html\" . text/html)\n   (\"xhtml\" . application/xhtml+xml)\n   (\"js\"  . application/javascript)\n   (\"css\" . text/css)\n   (\"png\" . image/png)\n   (\"xml\" . application/xml)\n   (\"pdf\" . application/pdf)\n   (\"jpeg\" . image/jpeg)\n   (\"jpg\" . image/jpeg)\n   (\"gif\" . image/gif)\n   (\"ico\" . image/vnd.microsoft.icon)\n   (\"txt\" . text/plain))") (p "See also " (tt "file-extension->mime-type") " for a procedure which can look up file extensions for you.")) (def (sig (parameter "(default-mime-type [mime-type])" (id default-mime-type))) (p "The mime-type (a symbol) to use if none was found in the " (tt "mime-type-map") ". Defaults to " (tt "'application/octet-stream"))) (def (sig (parameter "(default-host [hostname])" (id default-host))) (p "The host name to use when no virtual host could be determined from the request.  See the section on virtual hosts below.")) (def (sig (parameter "(vhost-map [host-regex->vhost-handler])" (id vhost-map))) (p "A mapping of virtual hosts (regex) to handlers (procedures of one argument; a continuation thunk). See the section on virtual hosts below. Defaults to " (tt "`((\".*\" . ,(lambda (continue) (continue))))"))) (def (sig (parameter "(file-extension-handlers [extension->handler-list])" (id file-extension-handlers))) (p "An alist mapping file extensions (strings) to handler procedures (lambdas of one argument; the file name relative to the webroot). Defaults to " (tt "'()") ". If no handler was found, defaults to just sending a static file.")) (def (sig (parameter "(access-log [log-file-or-port])" (id access-log))) (p "Filename (string) or port to append access log output to.  Default: " (tt "#f") " (disabled)")) (def (sig (parameter "(error-log [log-file-or-port])" (id error-log))) (p "Filename (string) or port to which error messages from evaluated code should be output. Default: " (tt "(current-error-port)"))) (def (sig (parameter "(debug-log [log-file-or-port])" (id debug-log))) (p "Filename (string) or port to write debugging messages to.  Default: " (tt "#f") " (disabled)")) (def (sig (parameter "(access-file [string])" (id access-file))) (p "The name of an access file, or " (tt "#f") " if not applicable.  This file is read when the directory is entered by the directory traversal system, and allows you to write dynamic handlers that can assign new values for parameters only for resources below that directory, very much like adding parameters in code before calling a procedure.  See the section \"Access files\" for more information."))) (section 3 "Handlers" (p "Besides \"static\" configuration, Spiffy also has several handlers for when something is to be served.") (def (sig (parameter "(handle-directory [proc])" (id handle-directory))) (p "The handler for directory entries. If the requested URL points to a directory which has no index file, this handler is invoked. It is a procedure of one argument, the path (a string) relative to the webroot. Defaults to a procedure which returns a \"403 forbidden\".")) (def (sig (parameter "(handle-file [proc])" (id handle-file))) (p "The handler for files. If the requested URL points to a file, this handler is invoked to serve the file. It is a procedure of one argument, the path (a string) relative to the webroot. Defaults to a procedure which sets the content-type and determines a handler based on the " (tt "file-extension-handlers") ", or " (tt "send-static-file") " if none was found.")) (def (sig (parameter "(handle-not-found [proc])" (id handle-not-found))) (p "The handler for nonexisting files. If the requested URL does not point to an existing file or directory, this procedure is called. It is a procedure of one argument, the path (a string) that was requested. This path should be interpreted as being relative to the webroot (even though it points to no existing file). Defaults to a procedure which returns a \"404 Not found\".")) (def (sig (parameter "(handle-exception [proc])" (id handle-exception))) (p "The handler for when an exception occurs. This defaults to a procedure that logs the error to the error log. While debugging or developing, it may be more convenient to use a procedure that sends the error back to the client:") (highlight scheme "(handle-exception\n  (lambda (exn chain)\n    (send-status 500 \"Internal server error\" (build-error-message exn chain))))")) (def (sig (parameter "(handle-access-logging [proc])" (id handle-access-logging))) (p "The handler for access logging. This is a procedure of zero arguments which should write a line to the access log. Defaults to a procedure which writes a line to " (tt "access-log") " which looks like this:") (pre "  127.0.0.1 [Sun Nov 16 15:16:01 2008] \"GET http://localhost:8080/foo?bar HTTP/1.1\" 200 \"http://localhost:8080/referer\" \"Links (2.2; NetBSD 5.99.01 macppc; x)\""))) (section 3 "Runtime information" (p "During the handling of a request, Spiffy adds more information to the environment by parameterizing the following parameters whenever the information becomes available:") (def (sig (parameter "(current-request [request])" (id current-request))) (p "An intarweb request-object that defines the current request. Available from the moment the request comes in and is parsed. Contains, among other things, the query parameters and the request-headers, in fully parsed form (as intarweb returns them).") (p "The URI is automatically augmented with the host, scheme and port if it is not an absolute URI.")) (def (sig (parameter "(current-response [response])" (id current-response))) (p "An intarweb response-object that defines the current response. Available from the same time current-request is available. This keeps getting updated along the way, while the response data is being refined (like when headers are being added).")) (def (sig (parameter "(current-file [path])" (id current-file))) (p "The path to the requested file (a string). Available from the moment Spiffy determined the requested URL points to a file (just before the " (tt "handle-file") " procedure is called). This file is relative to the " (tt "root-path") ".")) (def (sig (parameter "(current-pathinfo [path])" (id current-pathinfo))) (p "The trailing path " (i "fragments") " (a list of strings) that were passed in the URL after the requested filename. Available from the moment Spiffy determined the requested URL points to a file (just before the " (tt "handle-file") " procedure is called).")) (def (sig (parameter "(remote-address [address])" (id remote-address))) (p "The IP address (a string) of the user-agent performing the current request.")) (def (sig (parameter "(local-address [address])" (id local-address))) (p "The IP address (a string) on which the current request came in.")) (def (sig (parameter "(secure-connection? [boolean])" (id secure-connection?))) (p (tt "#t") " when the current connection is a secure one (SSL), " (tt "#f") " if it isn't (regular HTTP).  This pertains only to the direct connection itself, so if Spiffy is behind a proxy this will be " (tt "#f") " even if the proxy itself is connected to the client over SSL."))) (section 3 "Virtual hosts" (p "Spiffy has support for virtual hosting, using the HTTP/1.1 Host header.  This allows you to use one Spiffy instance running on one IP address/port number to serve multiple webpages, as determined by the hostname that was requested.") (p "The virtual host is defined by a procedure, which can set arbitrary parameters on-the-fly. It is passed a continuation thunk, which it should explicitly call if it wants the processing to continue.  The most used parameter in virtual host setups is the " (tt "root-path") " parameter, so that another docroot can be selected based on the requested hostname, showing different websites for different hosts:") (highlight scheme "(vhost-map `((\"foo\\\\.bar\\\\.com\" .\n               ,(lambda (continue)\n                  (parameterize ((file-extension-handlers\n                                   `((\"ssp\" . ,ssp-handler) (\"ws\" . ,web-scheme-handler)))\n                                 (root-path \"/var/www/domains/foo.bar.com\"))\n                     (continue))))\n             (,(glob->regexp \"*.domain.com\") .\n                ,(lambda (continue)\n                   (parameterize ((file-extension-handlers\n                                    `((\"php\" . ,(cgi-handler* \"/usr/pkg/libexec/cgi-bin/php\"))))\n\t\t\t\t  ;; You can also change PHP's arg_separator.input\n\t\t\t\t  ;; to be \";&\" instead of this parameter\n\t\t\t\t  (form-urlencoded-separator \"&\")\n                                  (root-path \"/var/www/domains/domain.com\"))\n                     (continue))))))") (p "In this example, if a client accesses " (tt "foo.bar.com/mumble/blah.html") ", the file " (tt "/var/www/domains/foo.bar.com/mumble/blah.html") " will be served.  Any files ending in " (tt ".ssp") " or " (tt ".ws") " will be served by the corresponding file type handler.  If there's any PHP file, its source will simply be displayed.  In case of " (tt "my.domain.com/something/bar.html") ", the file " (tt "/var/www/domains/domain.com/something/bar.html") " will be served.  If there's a " (tt ".ssp") " or " (tt ".ws") " file there, it will not be interpreted. Its source will be displayed instead.  A " (tt ".php") " file, on the other hand, will be passed via CGI to the program " (tt "/usr/pkg/bin/php") ".") (p "Domain names are mapped to a lambda that sets up any parameters it wants to override from the defaults.  The host names are matched using " (tt "string-match") ".  If the host name is not yet a regexp, it will be converted to a " (i "case-insensitive") " regexp.")) (section 3 "Access files" (p "Fine-grained access-control can be implemented by using so-called access files.  When a request for a specific file is made and a file with the name given in the " (tt "access-file") " parameter exists in any directory between the " (tt "root-path") " of that vhost and the directory in which the file resides, then the access file is loaded as an s-expression containing a function and is evaluated with a single argument, the function that should be called to continue processing the request.") (p "This works just like vhosting.  The function that gets called can call " (tt "parameterize") " to set additional constraints on the code that handles deeper directories.") (p "For example, if we evaluate " (tt "(access-file \".access\")") " before starting the server, and we put the following code in a file named " (tt ".access") " into the root-directory, then all accesses to any file in the root-directory or any subdirectory will be denied unless the request comes from localhost:") (highlight scheme " (lambda (continue)\n   (if (string=? (remote-address) \"127.0.0.1\")\n       (continue)\n       (send-status 403 \"Forbidden\" \"Sorry, you're not allowed here\")))") (p "If we only want to deny access to files that start with an X, put this in the " (tt ".access") " file:") (highlight scheme " (lambda (continue)\n   (let ((old-handler (handle-file)))\n     (parameterize ((handle-file\n                      (lambda (path)\n\t  \t        (if (not (string-prefix? \"X\" (pathname-file path)))\n\t\t\t    (send-status 403 \"Forbidden\" \"No X-files allowed!\")\n\t\t\t    (old-handler path)))))\n       (continue))))") (p "Of course, access files can be used for much more than just access checks.  One can put anything in them that could be put in vhost configuration or in top-level configuration.") (p "They are very useful for making deployable web applications, so you can just drop a directory on your server which has its own configuration embedded in an access file in the root directory of the application, without having to edit the server's main configuration files.")) (section 3 "Procedures and macros" (p "The following procedures and macros can be used in dynamic web programs, or dynamic server configuration:") (def (sig (procedure "(with-headers new-headers thunk)" (id with-headers))) (p "Call " (tt "thunk") " with the header list " (tt "new-headers") ". This parameterizes the current response to contain the new headers.  The existing headers are extended with " (tt "new-headers") " through intarweb's " (tt "headers") " procedure.")) (def (sig (procedure "(write-logged-response)" (id write-logged-response))) (p "This procedure simply writes " (tt "current-response") " after calling " (tt "handle-access-logging") ". Responses should always go through this procedure instead of directly using " (tt "write-response") " from intarweb.")) (def (sig (procedure "(log-to log format . rest)" (id log-to))) (p "Write a printf-style format string to the specified log (one of " (tt "access-log") ", " (tt "error-log") " or " (tt "debug-log") "). " (tt "format") " is a " (tt "printf") "-style format string, and rest arguments should match the arguments one would pass to printf. A newline is appended to the end of the log message automatically.")) (def (sig (procedure "(send-response #!key (code 200) (reason \"OK\") body (headers '()))" (id send-response))) (p "Easy way to send string data to the client, with additional headers. It will add appropriate headers and will automatically detect " (tt "HEAD") " requests.  If BODY is " (tt "#f") ", no body is sent and the " (tt "content-length") " header is set to zero.")) (def (sig (procedure "(send-status code reason [message])" (id send-status))) (p "Easy way to send a page and a status code to the client.  The optional message is a string containing HTML to add in the body of the response. Some structure will be added around the message, so message should only be the actual message you want to send.  Example:") (highlight scheme "(send-status 404 \"Not found\"\n \"Sorry, page not found! Please try <a href='/search.ws'>our search page</a>\")")) (def (sig (procedure "(send-static-file filename)" (id send-static-file))) (p "Send a file to the client. This sets the " (tt "content-length") " header and tries to send the file as quickly as possible to the client. The filename is interpreted relative to " (tt "root-path") ".")) (def (sig (procedure "(file-extension->mime-type EXT)" (id file-extension->mime-type))) (p "Looks up the file extension " (tt "EXT") " (without a trailing dot) in " (tt "mime-type-map") ", or uses " (tt "default-mime-type") " when the extension can't be found.") (p "If " (tt "EXT") " is " (tt "#f") ", it'll look up the extension that is the empty string.") (p "This returns a symbol which indicates the mime-type which is matched to the extension (for example " (tt "text/html") ").")) (def (sig (procedure "(restart-request request)" (id restart-request))) (p "Restart the entire request-handling starting at the point where the request was just parsed. The argument is the new request to use. Be careful, this makes it very easy to introduce unwanted endless loops!")) (def (sig (procedure "(htmlize string) => string" (id htmlize))) (p "Encode \"special\" html symbols like tag and attribute characters so they will not be interpreted by the browser.")) (def (sig (procedure "(build-error-message exn chain [raw-output])" (id build-error-message))) (p "Build an error message for the exception " (tt "exn") ", with call chain " (tt "chain") ". Defaults to HTML output, unless " (tt "raw-output") " is given and nonfalse."))) (section 3 "Modules" (p "This section will describe what the various modules that come with Spiffy are and how they work.") (section 4 "ssp-handler" (p "SSP, or Scheme Server Pages, are a way to embed Scheme in HTML pages. Files with an extension of " (tt ".ssp") " are handled specifically, by replacing occurrences of certain reserved tags with Scheme code. There are two possible forms, either the long version, where all output is redirected to the HTTP response port, or the short, where the result of the embedded expression is displayed in the response. The tags default to " (tt "<?scheme") " and " (tt "<?") ", see Configuration for how to change them.") (highlight scheme "   <html><body>\n   <ol><?scheme (for-each (lambda (i) (printf \"<li>~S~%\" i)) (iota 5))?></ol>\n   <br />\n   <b><?(call-with-values (lambda () (user-information (current-user-id))) (lambda (name . _) name))?><b>\n   </body></html>") (p "would generate for example something like this:") (pre "    1. 0\n    2. 1\n    3. 2\n    4. 3\n    5. 4 ") (pre " (felix x 500 100 /home/felix /bin/bash)") (p "When a " (tt ".ssp") " file is loaded the first time, or when it has been modified, then a translation takes place that generates a loadable Scheme source file (with the extension " (tt ".sspx") ", in the same directory as the original file) from the original data, so in the above example something like this would be generated:") (highlight scheme "  (let ()\n    (display \"<html><body>\\n<ol>\")\n    (for-each (lambda (i) (printf \"<li>~S~%\" i)) (iota 5))\n    (display \"</ol>\\n<br />\\n<b>\")\n    (display (call-with-values (lambda () (user-information (current-user-id))) (lambda (name . _) name)))\n    (display \"<b>\\n</body></html>\\n\") )") (p "Note that the body is evaluated in a " (tt "(let () ...)") " form.") (p "Note: each request runs in a separate thread, so code in " (tt ".ssp") " pages should take care when using global variables.") (section 5 "Configuration" (p "The SSP handler can be configured with the following options:") (def (sig (parameter "(ssp-short-open-tag [tag-regexp])" (id ssp-short-open-tag))) (p "The opening tag for short fragments. Default: " (tt "<?"))) (def (sig (parameter "(ssp-long-open-tag [tag-regexp])" (id ssp-long-open-tag))) (p "The opening tag for long fragments. Default: " (tt "<?scheme"))) (def (sig (parameter "(ssp-close-tag [tag-regexp])" (id ssp-close-tag))) (p "The closing tag for Scheme fragments in " (tt ".ssp") " files. Default: " (tt "?>"))) (def (sig (parameter "(ssp-eval-environment [environment])" (id ssp-eval-environment))) (p "The environment passed to " (tt "eval") " when evaluating Scheme code inside " (tt ".ssp") "-pages.  Default: " (tt "interaction-environment"))) (def (sig (parameter "(ssp-cache-dir [directory-name])" (id ssp-cache-dir))) (p "The directory under which to store cached .ssp files (these end in .sspx and are pure Scheme files).  Useful if you want to block write access to the webserver under your docroot.  Default: " (tt "\".\"")) (p "If it's a relative path, it is relative to " (tt "root-path") ", if absolute it's taken to be relative to the filesystem root.  A directory structure similar to the docroot will be created underneath this path, so for example if the file " (tt "/foo/bar/qux.ssp") " exists, and the cache dir is set to " (tt "/cache") ", it will create the file " (tt "/cache/foo/bar/qux.sspx") "."))) (section 5 "Runtime information" (p "For the duration of evaluating a SSP page, the following parameters will have a value assigned to them:") (def (sig (parameter "(current-workdir [path])" (id current-workdir))) (p "During execution, the current working directory of the SSP handler. Any of the \"include\" procedures (ssp-include, ssp-stringize) will interpret their file arguments to be relative to this directory.")) (def (sig (parameter "(ssp-exit-handler [handler])" (id ssp-exit-handler))) (p "During execution of an ssp page, " (tt "ssp-exit-handler") " is bound to a procedure that will finish the current page, ignoring any further content or code."))) (section 5 "Procedures" (p "The ssp-handler module adds the following procedures to the environment:") (def (sig (procedure "(ssp-handler filename)" (id ssp-handler))) (p "The handler itself, which should be used in the " (tt "file-extension-handlers") " parameter list.")) (def (sig (procedure "(ssp-include filename)" (id ssp-include))) (p "Translates the file " (tt "filename") " into Scheme by replacing " (tt "<?scheme ... ?>") " and " (tt "<? ... ?>") " sequences (if needed) and writes the translated contents to the current output-port.")) (def (sig (procedure "(ssp-stringize FILENAME)" (id ssp-stringize))) (p "Similar to " (tt "ssp-include") ", but instead of writing the translated text, the text is returned as a string.")))) (section 4 "web-scheme-handler" (p "Another way of executing Scheme code to produce content are " (tt ".ws") " files: these should contain a Scheme expression that is expected to evaluate to a string which will be directly written as the response to the current request. This facility is intended for Scheme code that uses the " (int-link "web-scheme") " extension.") (p "You can use the " (tt "web-scheme-handler") " for any Scheme file which returns HTML as a string or which has a side-effect of outputting the HTML. If it's the latter, make sure the final statement in your file does not return a string or it will be appended to the output (just like in the " (tt "csi") " REPL).") (p (b "Tip") " This handler type is perfect not only for web-scheme but also for when you're using " (tt "SRV:send-reply") " with SXML or for example a wiki-to-string translator.") (p "Note: each request runs in a separate thread, so code in " (tt ".ws") " pages should take care when using global variables.") (p "Note: web-scheme-handler is a separate extension and must be imported as such.") (highlight scheme "(require-extension web-scheme-handler)") (section 5 "Configuration" (p "The Web-scheme handler can be configured with the following options:") (def (sig (parameter "(web-scheme-eval-environment [environment])" (id web-scheme-eval-environment))) (p "The environment passed to " (tt "eval") " when evaluating Scheme code inside " (tt ".ws") "-pages.  Default: " (tt "interaction-environment")))) (section 5 "Procedures" (p "The Web-scheme handler adds only one procedure to the environment:") (def (sig (procedure "(web-scheme-handler filename)" (id web-scheme-handler))) (p "The handler itself, which should be used in the " (tt "file-extension-handlers") " parameter list.")))) (section 4 "cgi-handler" (p "Spiffy supports " (link "http://www.ietf.org/rfc/rfc3875" "CGI/1.1 as specified by RFC 3875") ".") (p "All request headers will be passed as environment variables to the CGI program, prefixed with " (tt "\"HTTP_\"") ", and converted to uppercase, with hyphens (\"-\") replaced by an underscore (\"_\"). The CGI program will receive the request body in unparsed form from stdin and should write a complete HTTP response to stdout.  Any headers that are missing but required for HTTP will be added by Spiffy.  For more info on how a CGI script is called, consult the spec.") (p "The " (tt "AUTH_TYPE") " and " (tt "REMOTE_USER") " environment variables are currently not set during invocation of CGI subprocesses. The " (tt "REMOTE_IDENT") " environment variable is not and never will be supported.") (section 5 "Configuration" (p "CGI handler can be configured with the following parameters:") (def (sig (procedure "(cgi-default-environment [env-alist])" (id cgi-default-environment))) (p "The environment variables that should be in the default environnment of every CGI program.  Variables like " (tt "SCRIPT_NAME") " will be added dynamically to the end of this alist.") (p "Default:") (highlight scheme "((\"GATEWAY_INTERFACE\" . \"CGI/1.1\"))"))) (section 5 "Procedures" (p "CGI-handler adds two procedures to the environment:") (def (sig (procedure "(cgi-handler filename [interpreter])" (id cgi-handler))) (p "The cgi handler simply calls CGI scripts. It is assumed the requested file is executable if no interpreter is given. (If used as a regular handler, it will only receive the filename).  The filename is taken to be relative to " (tt "(root-path)") ".")) (def (sig (procedure "(cgi-handler* [interpreter])" (id cgi-handler*))) (p "The " (tt "cgi-handler*") " procedure is usually more useful.  It allows you to define an interpreter to use for files and returns a new handler. See the example above for " (tt "file-extension-handlers") ".")))) (section 4 "simple-directory-handler" (p "In order to get directory listings, you can use " (tt "simple-directory-handler") ".  Just assign the " (tt "simple-directory-handler") " to " (tt "handle-directory") " and you're set.") (section 5 "Configuration" (p "The simple directory handler has a few configuration options:") (def (sig (procedure "(simple-directory-dotfiles? [dotfiles?])" (id simple-directory-dotfiles?))) (p "Determines if dotfiles should show up in the directory listings. Default: " (tt "#f"))) (def (sig (procedure "(simple-directory-display-file [displayer])" (id simple-directory-display-file))) (p "A lambda that accepts three arguments: the remote filename, the local filename and a boolean that says if the file is a directory.  This lambda should output a table row with the desired information. Defaults to a lambda that prints the name, size and date when the file was last modified."))) (section 5 "Procedures" (p "The simple-directory handler adds only one procedure to the environment:") (def (sig (procedure "(simple-directory-handler pathname)" (id simple-directory-handler))) (p "The handler itself, which should be used in the " (tt "handle-directory") " parameter."))))) (section 3 "Examples" (p "Spiffy is very easy to use for simple cases:") (highlight scheme "(use spiffy)\n\n(server-port 80)\n(root-path \"/var/www\")\n(start-server)") (p "One could also use parameterize:") (highlight scheme "(use spiffy)\n\n(parameterize ((server-port 80)\n               (root-path \"/var/www\"))\n  (start-server))") (section 4 "Network tweaks" (p "Spiffy does not activate Chicken's TCP buffering, which results in extra traffic: one packet sent per header line.  With a TCP buffer size greater than the total header length, all headers will be coalesced into a single write; generally the response body will be coalesced as well.  For example:") (pre "(tcp-buffer-size 2048)   ; from unit tcp\n(start-server)"))) (section 3 "Changelog" (ul (li "4.11 Drop openssl requirement (suggested by Felix Winkelmann); split up listening and accept loop invocation to allow loading code after dropping root privileges (suggested by Mario Goulart).") (li "4.10 Fix serious bug which caused Spiffy to exit after handling N requests. Fix handling of empty path components now that uri-generic preserves them.") (li "4.9 Export " (tt "file-extension->mime-type") ". Add more info about exceptional situations to the debugging logs when enabled.") (li "4.8 Fix ssl support. Get rid of " (tt "spiffy-root-uri") ". Add timestamp and request info to error log.") (li "4.7 Fix redirects for directories again (thanks to " (int-link "/users/mario-domenech-goulart" "Mario") "). NO TESTCASE (possibly to be fixed in " (int-link "uri-generic") ")") (li "4.6 Fix redirects for directories with special URI characters in them (thanks to " (int-link "/users/felix-winkelmann" "Felix") ")") (li "4.5 Add " (tt "send-response") " procedure; flush output after request is handled; use proper IANA-assigned MIME types in default " (tt "mime-type-map") "; fix " (tt "server-root-uri") " when spiffy is behind a proxy [thanks to zbigniew]") (li "4.4 Fix a problem with 304 \"not modified\", for which Safari incorrectly tries to read a content-body when a content-length is present.") (li "4.3 Fix crash with extensionless files and nonempty extension handlers") (li "4.2 Add support for caching headers and proper If-Modified-Since support") (li "4.1 Make cgi-handler cope with missing pathinfo. Fix statuscode related crash in cgi-handler. Make ssp handler's open/close tags parameters, so it actually matches what the documentation says. Add " (tt "ssp-cache-dir") ". Update for latest intarweb changes (0.2)") (li "4.0 Rewrite from scratch, using Intarweb") (li "pre-4.0 See the changelog for the " (int-link "/eggref/3/spiffy" "old spiffy")))) (section 3 "License" (pre " Copyright (c) 2005-2011, Felix L. Winkelmann and Peter Bex\n All rights reserved.\n \n Redistribution and use in source and binary forms, with or without\n modification, are permitted provided that the following conditions are\n met:\n \n Redistributions of source code must retain the above copyright\n notice, this list of conditions and the following disclaimer.\n \n Redistributions in binary form must reproduce the above copyright\n notice, this list of conditions and the following disclaimer in the\n documentation and/or other materials provided with the distribution.\n \n Neither the name of the author nor the names of its contributors may\n be used to endorse or promote products derived from this software\n without specific prior written permission.\n \n THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n \"AS IS\" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\n LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS\n FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE\n COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\n SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\n HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,\n STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED\n OF THE POSSIBILITY OF SUCH DAMAGE."))))